<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 55 CASE Statements | Data Management</title>
  <meta name="description" content="You’ll learn how to get data, get it into the most useful structure, transform it, visualize it and model it. In this course, you will find a practicum of skills for data science. You’ll learn how to clean data and draw plots—and many other things besides. These are the skills that allow data science to happen, and here you will find the best practices for doing each of these things. You’ll learn how to use the grammar of graphics, literate programming, and reproducible research to save time. You’ll also learn how to manage cognitive resources to facilitate discoveries when wrangling, visualizing and exploring data. This is a three-credit hour course." />
  <meta name="generator" content="bookdown 0.21.6 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 55 CASE Statements | Data Management" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="You’ll learn how to get data, get it into the most useful structure, transform it, visualize it and model it. In this course, you will find a practicum of skills for data science. You’ll learn how to clean data and draw plots—and many other things besides. These are the skills that allow data science to happen, and here you will find the best practices for doing each of these things. You’ll learn how to use the grammar of graphics, literate programming, and reproducible research to save time. You’ll also learn how to manage cognitive resources to facilitate discoveries when wrangling, visualizing and exploring data. This is a three-credit hour course." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 55 CASE Statements | Data Management" />
  
  <meta name="twitter:description" content="You’ll learn how to get data, get it into the most useful structure, transform it, visualize it and model it. In this course, you will find a practicum of skills for data science. You’ll learn how to clean data and draw plots—and many other things besides. These are the skills that allow data science to happen, and here you will find the best practices for doing each of these things. You’ll learn how to use the grammar of graphics, literate programming, and reproducible research to save time. You’ll also learn how to manage cognitive resources to facilitate discoveries when wrangling, visualizing and exploring data. This is a three-credit hour course." />
  

<meta name="author" content="Markum Reed" />


<meta name="date" content="2021-01-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="group-by-and-order-by.html"/>
<link rel="next" href="join-1.html"/>
<script src="libs/header-attrs-2.6.4/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

yes

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Management</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="case-statements" class="section level1" number="55">
<h1><span class="header-section-number">Section 55</span> CASE Statements</h1>
<p>A CASE statement allows us to map one or more conditions to a corresponding value for each condition. You start a CASE statement with the word CASE and conclude it with an END. Between those keywords, you specify each condition with the a WHEN [condition] THEN [value].</p>
<p>After specifying the condition-value pairs, you can have a catch-all value to default to if none of the conditions where met, which is specified in the ELSE.</p>
<pre><code>#!pip install ipython-sql
!git clone https://github.com/thomasnield/oreilly_getting_started_with_sql.git
%load_ext sql
%sql sqlite:///oreilly_getting_started_with_sql/weather_stations.db</code></pre>
<pre><code>Cloning into &#39;oreilly_getting_started_with_sql&#39;...
remote: Enumerating objects: 3, done.[K
remote: Counting objects: 100% (3/3), done.[K
remote: Compressing objects: 100% (3/3), done.[K
remote: Total 60 (delta 0), reused 0 (delta 0), pack-reused 57[K
Unpacking objects: 100% (60/60), done.





&#39;Connected: @oreilly_getting_started_with_sql/weather_stations.db&#39;</code></pre>
<pre><code>%%sql

SELECT report_code, year, month, day, wind_speed,

CASE
  WHEN wind_speed &gt;= 40 THEN &#39;HIGH&#39;
  WHEN wind_speed &gt;= 30 AND wind_speed &lt; 40 THEN &#39;MODERATE&#39;
  ELSE &#39;LOW&#39;
END as wind_severity
FROM station_data
LIMIT 10;</code></pre>
<pre><code> * sqlite:///oreilly_getting_started_with_sql/weather_stations.db
Done.</code></pre>
<table>
<tr>
<th>
report_code
</th>
<th>
year
</th>
<th>
month
</th>
<th>
day
</th>
<th>
wind_speed
</th>
<th>
wind_severity
</th>
</tr>
<tr>
<td>
34DDA7
</td>
<td>
2002
</td>
<td>
12
</td>
<td>
21
</td>
<td>
0.2
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
39537B
</td>
<td>
1998
</td>
<td>
10
</td>
<td>
1
</td>
<td>
6.7
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
C3C6D5
</td>
<td>
2001
</td>
<td>
5
</td>
<td>
18
</td>
<td>
4.3
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
145150
</td>
<td>
2007
</td>
<td>
10
</td>
<td>
14
</td>
<td>
2.5
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
EF616A
</td>
<td>
1967
</td>
<td>
7
</td>
<td>
29
</td>
<td>
1.2
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
1F8A7B
</td>
<td>
1953
</td>
<td>
6
</td>
<td>
18
</td>
<td>
3.6
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
D028D8
</td>
<td>
1981
</td>
<td>
6
</td>
<td>
27
</td>
<td>
3
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
C74611
</td>
<td>
1978
</td>
<td>
2
</td>
<td>
5
</td>
<td>
13.3
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
737090
</td>
<td>
1962
</td>
<td>
8
</td>
<td>
14
</td>
<td>
5.1
</td>
<td>
LOW
</td>
</tr>
<tr>
<td>
C5C66E
</td>
<td>
2006
</td>
<td>
10
</td>
<td>
15
</td>
<td>
1.7
</td>
<td>
LOW
</td>
</tr>
</table>
<div id="grouping-case-statements" class="section level2" number="55.1">
<h2><span class="header-section-number">55.1</span> Grouping CASE Statements</h2>
<p>When you create CAST statements and group them, you can create some very powerful transformations. Converting values based on one or more conditions before aggregating them gives us even more possibilities to slice data in interesting ways.</p>
<pre><code>%%sql

SELECT year,

CASE
  WHEN wind_speed &gt;= 40 THEN &#39;HIGHT&#39;
  WHEN wind_speed &gt;= 40 THEN &#39;MODERATE&#39;
  ELSE &#39;LOW&#39;
END as wind_seversity,

COUNT(*) as record_count

FROM station_data
GROUP BY 1, 2

LIMIT 10;</code></pre>
<pre><code> * sqlite:///oreilly_getting_started_with_sql/weather_stations.db
Done.</code></pre>
<table>
<tr>
<th>
year
</th>
<th>
wind_seversity
</th>
<th>
record_count
</th>
</tr>
<tr>
<td>
1930
</td>
<td>
LOW
</td>
<td>
5
</td>
</tr>
<tr>
<td>
1932
</td>
<td>
LOW
</td>
<td>
3
</td>
</tr>
<tr>
<td>
1933
</td>
<td>
LOW
</td>
<td>
6
</td>
</tr>
<tr>
<td>
1935
</td>
<td>
LOW
</td>
<td>
2
</td>
</tr>
<tr>
<td>
1936
</td>
<td>
LOW
</td>
<td>
18
</td>
</tr>
<tr>
<td>
1937
</td>
<td>
LOW
</td>
<td>
23
</td>
</tr>
<tr>
<td>
1938
</td>
<td>
LOW
</td>
<td>
13
</td>
</tr>
<tr>
<td>
1939
</td>
<td>
LOW
</td>
<td>
9
</td>
</tr>
<tr>
<td>
1940
</td>
<td>
LOW
</td>
<td>
26
</td>
</tr>
<tr>
<td>
1941
</td>
<td>
LOW
</td>
<td>
42
</td>
</tr>
</table>
</div>
<div id="the-zeronull-case-trick" class="section level2" number="55.2">
<h2><span class="header-section-number">55.2</span> The “Zero/Null” CASE Trick</h2>
<p>You can use tricks with the CASE statement. One simeple but useful pattern is the “zero/null” CASE trick. This allows you to apply different filters for different aggregate values, all in a single SELECT query.</p>
<pre><code>%%sql

SELECT year, month,

round(SUM(CASE WHEN tornado = 1 THEN precipitation ELSE 0 END),2) as tornado_precipitation,

round(SUM(CASE WHEN tornado = 0 THEN precipitation ELSE 0 END),2) as non_tornado_precipitation

FROM station_data
GROUP BY year, month
LIMIT 10;</code></pre>
<pre><code> * sqlite:///oreilly_getting_started_with_sql/weather_stations.db
Done.</code></pre>
<table>
<tr>
<th>
year
</th>
<th>
month
</th>
<th>
tornado_precipitation
</th>
<th>
non_tornado_precipitation
</th>
</tr>
<tr>
<td>
1930
</td>
<td>
6
</td>
<td>
0.0
</td>
<td>
0.0
</td>
</tr>
<tr>
<td>
1930
</td>
<td>
10
</td>
<td>
0.0
</td>
<td>
None
</td>
</tr>
<tr>
<td>
1932
</td>
<td>
3
</td>
<td>
0.0
</td>
<td>
0.0
</td>
</tr>
<tr>
<td>
1933
</td>
<td>
3
</td>
<td>
0.0
</td>
<td>
0.0
</td>
</tr>
<tr>
<td>
1933
</td>
<td>
7
</td>
<td>
0.0
</td>
<td>
None
</td>
</tr>
<tr>
<td>
1935
</td>
<td>
7
</td>
<td>
0.0
</td>
<td>
0.0
</td>
</tr>
<tr>
<td>
1936
</td>
<td>
8
</td>
<td>
0.0
</td>
<td>
0.64
</td>
</tr>
<tr>
<td>
1936
</td>
<td>
9
</td>
<td>
0.0
</td>
<td>
0.0
</td>
</tr>
<tr>
<td>
1936
</td>
<td>
10
</td>
<td>
0.0
</td>
<td>
0.27
</td>
</tr>
<tr>
<td>
1936
</td>
<td>
11
</td>
<td>
0.0
</td>
<td>
0.06
</td>
</tr>
</table>
<p>The CASE statement can do an impressive amount of work, especially in complex aggregation task. By leverageing a condition to make a value 0 if the condition is not met, we effectively ignore that value and exclude it from the SUM (since adding 0 has no impact).</p>
<p>You could so a similar calculation with MIN or MAX operations, and us a null instead of 0 to make sure values with certain coinditon are never considered:</p>
<pre><code>%%sql
SELECT year,

MAX(CASE WHEN tornado = 0 THEN precipitation ELSE NULL END) as max_non_tornado_precipitation,

MAX(CASE WHEN tornado = 1 THEN precipitation ELSE NULL END) as max_tornado_precipitation
FROM station_data
WHERE year &gt;= 1990
GROUP BY year
LIMIT 10;</code></pre>
<pre><code> * sqlite:///oreilly_getting_started_with_sql/weather_stations.db
Done.</code></pre>
<table>
<tr>
<th>
year
</th>
<th>
max_non_tornado_precipitation
</th>
<th>
max_tornado_precipitation
</th>
</tr>
<tr>
<td>
1990
</td>
<td>
2.48
</td>
<td>
0.59
</td>
</tr>
<tr>
<td>
1991
</td>
<td>
2.36
</td>
<td>
1.93
</td>
</tr>
<tr>
<td>
1992
</td>
<td>
1.5
</td>
<td>
1.51
</td>
</tr>
<tr>
<td>
1993
</td>
<td>
1.18
</td>
<td>
2.13
</td>
</tr>
<tr>
<td>
1994
</td>
<td>
1.26
</td>
<td>
1.16
</td>
</tr>
<tr>
<td>
1995
</td>
<td>
0.91
</td>
<td>
0.35
</td>
</tr>
<tr>
<td>
1996
</td>
<td>
3.31
</td>
<td>
0.68
</td>
</tr>
<tr>
<td>
1997
</td>
<td>
1.18
</td>
<td>
0.08
</td>
</tr>
<tr>
<td>
1998
</td>
<td>
1.22
</td>
<td>
0.2
</td>
</tr>
<tr>
<td>
1999
</td>
<td>
2.64
</td>
<td>
0.25
</td>
</tr>
</table>
<p>Just like the WHERE statement, you can use any Boolean expression in a CASE statement, in cluding function and AND, OR, and NOT statements. The following query will find the avarage temperatures by month when rain/hail was present versus not present after the year 2000:</p>
<pre><code>%%sql

SELECT month, 

round(AVG(CASE WHEN rain OR hail THEN temperature ELSE null END),2) as avg_precipitation_temp,

round(AVG(CASE WHEN NOT (rain OR hail) THEN temperature ELSE null END),2) as avg_non_precipitation_temp

FROM station_data
WHERE year &gt; 2000
GROUP BY month
LIMIT 10;</code></pre>
<pre><code> * sqlite:///oreilly_getting_started_with_sql/weather_stations.db
Done.</code></pre>
<table>
<tr>
<th>
month
</th>
<th>
avg_precipitation_temp
</th>
<th>
avg_non_precipitation_temp
</th>
</tr>
<tr>
<td>
1
</td>
<td>
35.62
</td>
<td>
41.79
</td>
</tr>
<tr>
<td>
2
</td>
<td>
33.8
</td>
<td>
38.9
</td>
</tr>
<tr>
<td>
3
</td>
<td>
46.61
</td>
<td>
49.23
</td>
</tr>
<tr>
<td>
4
</td>
<td>
49.03
</td>
<td>
52.33
</td>
</tr>
<tr>
<td>
5
</td>
<td>
55.9
</td>
<td>
58.91
</td>
</tr>
<tr>
<td>
6
</td>
<td>
55.4
</td>
<td>
64.85
</td>
</tr>
<tr>
<td>
7
</td>
<td>
66.98
</td>
<td>
70.02
</td>
</tr>
<tr>
<td>
8
</td>
<td>
66.68
</td>
<td>
67.89
</td>
</tr>
<tr>
<td>
9
</td>
<td>
60.66
</td>
<td>
62.4
</td>
</tr>
<tr>
<td>
10
</td>
<td>
53.01
</td>
<td>
56.36
</td>
</tr>
</table>
<pre><code></code></pre>

<div id="preamble-1" class="section level3" number="55.2.1">
<h3><span class="header-section-number">55.2.1</span> PREAMBLE</h3>
<pre><code>#!pip install ipython-sql
!git clone https://github.com/thomasnield/oreilly_getting_started_with_sql.git
%load_ext sql
%sql sqlite:///oreilly_getting_started_with_sql/rexon_metals.db</code></pre>
<pre><code>fatal: destination path &#39;oreilly_getting_started_with_sql&#39; already exists and is not an empty directory.
The sql extension is already loaded. To reload it, use:
  %reload_ext sql





&#39;Connected: @oreilly_getting_started_with_sql/rexon_metals.db&#39;</code></pre>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="group-by-and-order-by.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="join-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["data_management.pdf", "data_management.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
